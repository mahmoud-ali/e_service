{% extends 'acceptance/base.html' %}

{% block content %}
{% load needs_request_tags %}

<div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">تفاصيل طلب توفير إحتياج</h1>
    <div>
        {% if user_can_update and user|has_group:"eom_pub" and user_current_task.node.bpmn_id == 'Activity_dga_approval_or_rejection'%}
        <a href="{% url 'needs:needs_request_update' needs_request.pk %}" class="btn btn-warning">تعديل</a>
        {% endif %}
        <a href="{% url 'needs:needs_request_list' %}" class="btn btn-outline">العودة إلى القائمة</a>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <div class="lg:col-span-2">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">معلومات الطلب</h2>
                <p><strong>رقم الطلب:</strong> {{ needs_request.id }}</p>
                <p><strong>التاريخ:</strong> {{ needs_request.date }}</p>
                <p><strong>القسم:</strong> {{ needs_request.department }}</p>
                <p><strong>سبب الحوجة:</strong> {{ needs_request.cause }}</p>
            </div>
        </div>

        <div class="card bg-base-100 shadow-xl mt-4">
            <div class="card-body">
                <h2 class="card-title">الأصناف المطلوبة</h2>
                    <div class="overflow-x-auto">
                        <table class="table w-full">
                            <thead>
                                <tr>
                                    <th># </th>
                                    <th>اسم الصنف </th>
                                    <th>الكمية المطلوبة</th>
                                    {% comment %} <th>الكمية المعتمدة</th> {% endcomment %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for obj in needs_request.items.all %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ obj.requested_item }}</td>
                                    <td>{{ obj.no_of_requested_items }}</td>
                                    {% comment %} <td>{{ obj.no_of_approved_items }}</td> {% endcomment %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        
        {% if user_current_task and user_current_task.node.bpmn_id == 'Task_GM_Approval' %}
        {% comment %} <div class="card bg-base-100 shadow-xl mt-4">
            <div class="card-body">
                <h2 class="card-title">تعديل الأصناف المطلوبة</h2>

                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="action_items">
                        {{ item_action_formset.management_form }}
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr>
                                        <th>الصنف</th>
                                        <th>الكمية المطلوبة</th>
                                        <th>الكمية المعتمدة</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for form in item_action_formset %}
                                    <tr>
                                        <td>{{ form.instance.requested_item }}</td>
                                        <td>
                                            {{ form.no_of_requested_items }}
                                            {{ form.id }}
                                        </td>
                                        <td>
                                            {{ form.no_of_approved_items }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <button type="submit" class="btn btn-primary mt-4">حفظ الكميات</button>
                    </form>
            </div>
        </div> {% endcomment %}
        {% endif %}

        <div class="card bg-base-100 shadow-xl mt-4">
            <div class="card-body">
                <h2 class="card-title">التعليقات والتوصيات</h2>
                {% if needs_request.sd_comment %}<p><strong>تعليق قسم الإمداد:</strong> {{ needs_request.sd_comment|default:"لا يوجد" }}</p>{% endif %}
                {% if needs_request.doa_comment %}<p><strong>تعليق مدير الشؤون الإدارية:</strong> {{ needs_request.doa_comment|default:"لا يوجد" }}</p>{% endif %}
                {% if needs_request.it_comment %}<p><strong>تعليق تقنية المعلومات:</strong> {{ needs_request.it_comment|default:"لا يوجد" }}</p>{% endif %}
                {% if needs_request.dgdhra_recommendation %}<p><strong>توصية مدير الإدارة العامة للموارد البشرية والإدارة:</strong> {{ needs_request.dgdhra_recommendation|default:"لا يوجد" }}</p>{% endif %}
                {% if needs_request.dgfa_recommendation %}<p><strong>توصية مدير الإدارة العامة للشؤون المالية:</strong> {{ needs_request.dgfa_recommendation|default:"لا يوجد" }}</p>{% endif %}
            </div>
        </div>

        <!-- WORKFLOW TIMELINE -->
        {% if timeline %}
<div tabindex="0" class="collapse collapse-arrow bg-base-100 border-base-300 border  shadow-xl mt-4">
    <input type="checkbox" />
  <div class="collapse-title font-semibold">سجل سير الموافقات (Workflow Timeline)</div>
  <div class="collapse-content text-sm">

        <div class="card bg-base-100">
            <div class="card-body">
                {% comment %} <h2 class="card-title">سجل سير الموافقات (Workflow Timeline)</h2> {% endcomment %}
                <div class="timeline-container">
                    <ul class="timeline timeline-vertical">
                        {% for log in timeline %}
                        <li>
                            <div class="timeline-start">{{ log.timestamp|date:"Y-m-d H:i" }}</div>
                            <div class="timeline-middle">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="timeline-end timeline-box">
                                <div class="font-bold">{{ log.get_event_type_display }}</div>
                                {% if log.actor %}
                                <div class="text-sm">المستخدم: {{ log.actor.get_full_name|default:log.actor.username }}</div>
                                {% endif %}
                                {% if log.node %}
                                <div class="text-sm">المرحلة: {{ log.node.name }}</div>
                                {% endif %}
                                {% comment %} {% if log.details %}
                                <div class="text-xs text-gray-500 mt-1">
                                    {% for key, value in log.details.items %}
                                        {% if key != 'variables' and key != 'from_node' %}
                                        <span>{{ key }}: {{ value }}</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %} {% endcomment %}
                            </div>
                            <hr/>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
  </div>
</div>        
        {% endif %}
    </div>

    <div>
        <!-- WORKFLOW STATUS -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">حالة الموافقة</h2>                
                {% if workflow %}
                    {% if workflow.status == 'completed' %}
                        <div class="alert alert-success">
                            <span>تصدق</span>
                        </div>
                    {% elif workflow.status == 'terminated' %}
                        <div class="alert alert-error">
                            <span>مرفوض</span>
                        </div>
                        {% if needs_request.rejection_cause %}
                        <p class="mt-2"><strong>سبب الرفض:</strong> {{ needs_request.rejection_cause }}</p>
                        {% endif %}
                    {% elif workflow.status == 'active' %}
                        <div class="alert alert-warning">
                            <span>قيد الإجراء</span>
                        </div>
                        {% if user_current_task %}
                        <p class="mt-2"><strong>المرحلة الحالية:</strong> {{ user_current_task.node.name }}</p>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <!-- Fallback to old status display -->
                    {% if needs_request.approval_status == 'gm_approval' %}
                        <div class="alert alert-success">
                            <span>مقبول نهائيًا</span>
                        </div>
                    {% elif needs_request.is_rejected %}
                        <div class="alert alert-error">
                            <span>مرفوض</span>
                        </div>
                        <p><strong>سبب الرفض:</strong> {{ needs_request.rejection_cause }}</p>
                    {% else %}
                        <div class="alert alert-warning">
                            <span>{{ needs_request.get_approval_status_display }}</span>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- WORKFLOW ACTIONS -->
        {% if user_current_task and workflow.status == 'active' %}
        <div class="card bg-base-100 shadow-xl mt-4">
            <div class="card-body">
                <h2 class="card-title">الإجراءات المطلوبة</h2>
                <p class="text-sm mb-4">أنت مسؤول عن: <strong>{{ user_current_task.node.name }}</strong></p>

                {% if user_current_task.node.bpmn_id == 'Activity_dga_approval_or_rejection' %}
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    <div class="flex gap-2">
                        <button type="submit" name="action" value="dga_approval" class="btn btn-success flex-1">موافقة</button>
                    </div>
                </form>
                
                {% if user_current_task.node.bpmn_id == 'Activity_dga_approval_or_rejection' %}
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="dga_rejection">
                    {{ rejection_form.as_p }}
                    <button type="submit" class="btn btn-error w-full">رفض مع السبب</button>
                </form>
                {% endif %}

                {% elif user_current_task.node.bpmn_id == 'Activity_sd_comment' %}
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="sd_comment">
                    {{ comment_form.as_p }}
                    <button type="submit" class="btn btn-primary w-full">إضافة التعليق</button>
                </form>

                {% elif user_current_task.node.bpmn_id == 'Activity_doa_comment' %}
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="doa_comment">
                    {{ doa_comment_form.as_p }}
                    <button type="submit" class="btn btn-primary w-full">إضافة التعليق</button>
                </form>

                {% elif user_current_task.node.bpmn_id == 'Activity_it_comment' %}
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="it_comment">
                    {{ it_comment_form.as_p }}
                    <button type="submit" class="btn btn-primary w-full">إضافة التعليق</button>
                </form>

                {% elif user_current_task.node.bpmn_id == 'Activity_dgdhra_recommendation' %}
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="dgdhra_recommendation">
                    {{ dgdhra_form.as_p }}
                    <button type="submit" class="btn btn-primary w-full">إضافة التوصية</button>
                </form>

                {% elif user_current_task.node.bpmn_id == 'Activity_dgfa_recommendation' %}
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="dgfa_recommendation">
                    {{ dgfa_form.as_p }}
                    <button type="submit" class="btn btn-primary w-full">إضافة التوصية</button>
                </form>

                {% elif user_current_task.node.bpmn_id == 'Activity_agmfa_approval_or_rejection' %}
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    <div class="flex gap-2">
                        <button type="submit" name="action" value="agmfa_approval" class="btn btn-success flex-1">إعتماد</button>
                    </div>
                </form>
                
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="agmfa_rejection">
                    {{ rejection_form.as_p }}
                    <button type="submit" class="btn btn-error w-full">رفض مع السبب</button>
                </form>

                {% elif user_current_task.node.bpmn_id == 'Activity_gm_approval_or_rejection' %}
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    <div class="flex gap-2">
                        <button type="submit" name="action" value="gm_approval" class="btn btn-success flex-1">تصديق</button>
                    </div>
                </form>
                
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="gm_rejection">
                    {{ rejection_form.as_p }}
                    <button type="submit" class="btn btn-error w-full">رفض مع السبب</button>
                </form>
                {% endif %}

            </div>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}
